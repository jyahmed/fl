<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حذف الحساب</title>
    <style>
        /* نفس تصميم CSS من الرد السابق */
        body { font-family: 'Cairo', sans-serif; line-height: 1.8; color: #333; background-color: #f4f7f6; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { max-width: 500px; width: 100%; background-color: #fff; padding: 30px 40px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        h1 { color: #d9534f; text-align: center; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; text-align: left; direction: ltr; }
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; background-color: #0275d8; color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .message { padding: 15px; margin-top: 20px; border-radius: 8px; text-align: center; display: none; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        #otp-section { display: none; }
        #final-message-section { display: none; text-align: center; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>حذف الحساب نهائياً</h1>
        <div id="message-box" class="message"></div>

        <div id="phone-section">
            <p>أدخل رقم هاتفك المسجل لدينا لبدء عملية الحذف.</p>
            <div class="form-group">
                <label for="phone">رقم الهاتف (بدون رمز الدولة )</label>
                <input type="tel" id="phone" placeholder="7xxxxxxxx">
            </div>
            <button id="send-otp-btn" onclick="sendOTP()">إرسال رمز التحقق</button>
        </div>

        <div id="otp-section">
            <p>لقد أرسلنا رمزًا إلى رقمك. يرجى إدخاله أدناه.</p>
            <div class="form-group">
                <label for="otp">رمز التحقق (OTP)</label>
                <input type="text" id="otp" placeholder="xxxxxx">
            </div>
            <button id="verify-otp-btn" onclick="scheduleDeletion()">تأكيد وحذف الحساب</button>
        </div>

        <div id="final-message-section">
            <h2 class="success">تم استلام طلبك بنجاح</h2>
            <p>لقد قمت بطلب حذف حسابك. سيتم الاحتفاظ ببياناتك لمدة 10 أيام، إذا لم تقم بتسجيل الدخول خلال هذه الفترة، سيتم حذف بياناتك بشكل نهائي.</p>
        </div>
    </div>

    <!-- استيراد Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // =================================================================
        // === [هام جداً] - أدخل معلوماتك السرية هنا ===
        // =================================================================
const firebaseConfig = {
  apiKey: "AIzaSyBkYLrmedVI9VZOCZ0xj6HvVSsGGm8OhHs",
  authDomain: "coffee-spark-ai-barista-41d7a.firebaseapp.com",
  projectId: "coffee-spark-ai-barista-41d7a",
  storageBucket: "coffee-spark-ai-barista-41d7a.firebasestorage.app",
  messagingSenderId: "515148094227",
  appId: "1:515148094227:web:845baa681e936daa0b98e6"
}
        const TWILIO_ACCOUNT_SID = "AC3d5fc57054e85ebea2512a1604384c9b";
        const TWILIO_AUTH_TOKEN = "f3b2301402f1a0a1f7bceb8ba4ecc581";
        const TWILIO_VERIFY_SID = "VAf0e4ebb6abb0db7e9b5473d93c4312d6";
        // =================================================================

        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig );
        const db = firebase.firestore();

        // عناصر الواجهة
        const phoneInput = document.getElementById('phone');
        const otpInput = document.getElementById('otp');
        const sendOtpBtn = document.getElementById('send-otp-btn');
        const verifyOtpBtn = document.getElementById('verify-otp-btn');
        const messageBox = document.getElementById('message-box');
        const phoneSection = document.getElementById('phone-section');
        const otpSection = document.getElementById('otp-section');
        const finalMessageSection = document.getElementById('final-message-section');

        function showMessage(text, type) {
            messageBox.textContent = text;
            messageBox.className = `message ${type}`;
            messageBox.style.display = 'block';
        }

        function setLoading(button, isLoading) {
            button.disabled = isLoading;
            button.textContent = isLoading ? 'جاري المعالجة...' : button.dataset.originalText;
        }

        async function sendOTP() {
            const phone = phoneInput.value.trim();
            if (!/^(71|78|73|70|77)[0-9]{7}$/.test(phone)) {
                showMessage('الرجاء إدخال رقم هاتف يمني صحيح.', 'error');
                return;
            }

            sendOtpBtn.dataset.originalText = sendOtpBtn.textContent;
            setLoading(sendOtpBtn, true);
            messageBox.style.display = 'none';

            try {
                // التحقق من وجود المستخدم في Firestore أولاً
                const userQuery = await db.collection("users").where("phone", "==", phone).limit(1).get();
                if (userQuery.empty) {
                    throw new Error("الحساب غير موجود.");
                }

                // إرسال طلب إلى Twilio مباشرة
                const url = `https://verify.twilio.com/v2/Services/${TWILIO_VERIFY_SID}/Verifications`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa(`${TWILIO_ACCOUNT_SID}:${TWILIO_AUTH_TOKEN}` ),
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        'To': `+967${phone}`,
                        'Channel': 'sms'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'فشل إرسال الرمز.');
                }

                showMessage('تم إرسال رمز التحقق بنجاح.', 'success');
                phoneSection.style.display = 'none';
                otpSection.style.display = 'block';

            } catch (error) {
                showMessage(error.message, 'error');
            } finally {
                setLoading(sendOtpBtn, false);
            }
        }

        async function scheduleDeletion() {
            const phone = phoneInput.value.trim();
            const code = otpInput.value.trim();

            if (code.length < 4) {
                showMessage('الرجاء إدخال رمز تحقق صحيح.', 'error');
                return;
            }

            verifyOtpBtn.dataset.originalText = verifyOtpBtn.textContent;
            setLoading(verifyOtpBtn, true);
            messageBox.style.display = 'none';

            try {
                // التحقق من الرمز عبر Twilio
                const url = `https://verify.twilio.com/v2/Services/${TWILIO_VERIFY_SID}/VerificationCheck`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa(`${TWILIO_ACCOUNT_SID}:${TWILIO_AUTH_TOKEN}` ),
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        'To': `+967${phone}`,
                        'Code': code
                    })
                });

                const data = await response.json();
                if (data.status !== 'approved') {
                    throw new Error('رمز التحقق غير صحيح.');
                }

                // إذا كان الرمز صحيحًا، قم بتحديث Firestore
                const userQuery = await db.collection("users").where("phone", "==", phone).limit(1).get();
                if (userQuery.empty) {
                    throw new Error("حدث خطأ: الحساب غير موجود.");
                }

                const userDoc = userQuery.docs[0];
                await userDoc.ref.update({
                    status: "pendingDeletion",
                    deletionScheduledAt: new Date() // استخدام تاريخ المتصفح
                });

                // إظهار رسالة النجاح النهائية
                otpSection.style.display = 'none';
                document.querySelector('h1').style.display = 'none';
                finalMessageSection.style.display = 'block';

            } catch (error) {
                showMessage(error.message, 'error');
            } finally {
                setLoading(verifyOtpBtn, false);
            }
        }
    </script>
</body>
</html>
