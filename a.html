<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>حذف الحساب عبر Hypersender — صفحة واحدة</title>
  <style>
    body { font-family: 'Cairo', sans-serif; line-height:1.8; color:#333; background:#f4f7f6; margin:0; padding:20px;
           display:flex; justify-content:center; align-items:center; min-height:100vh; }
    .container { max-width:500px; width:100%; background:#fff; padding:30px 40px; border-radius:12px;
                 box-shadow:0 6px 20px rgba(0,0,0,.08); }
    h1 { color:#d9534f; text-align:center; margin:0 0 12px 0; }
    .form-group { margin-bottom:18px; }
    label { display:block; margin-bottom:8px; font-weight:bold; }
    input { width:100%; padding:12px; border:1px solid #ccc; border-radius:8px; box-sizing:border-box; direction:ltr; text-align:left; }
    button { width:100%; padding:14px; border:none; border-radius:8px; background:#0275d8; color:#fff; font-size:16px; font-weight:700; cursor:pointer; }
    button:disabled { background:#a0a0a0; cursor:not-allowed; }
    .message { padding:14px; margin-top:18px; border-radius:8px; text-align:center; display:none; }
    .success { background:#d4edda; color:#155724; }
    .error { background:#f8d7da; color:#721c24; }
    #otp-section { display:none; }
    #final-message-section { display:none; text-align:center; }
    .note { font-size:13px; color:#666; margin-top:10px; text-align:center; }
    .small { font-size:12px; color:#666; margin-top:6px; }
  </style>
</head>
<body>
  <div class="container" role="main">
    <h1>حذف الحساب نهائياً</h1>

    <div id="message-box" class="message"></div>

    <div id="phone-section">
      <p>أدخل رقم هاتفك مع رمز الدولة لاستخدام Hypersender في إرسال رمز OTP.</p>
      <div class="form-group">
        <label for="phone">رقم الهاتف (مثال: +9677XXXXXXXX)</label>
        <input id="phone" type="tel" placeholder="+9677XXXXXXXX" />
      </div>
      <button id="send-otp-btn" onclick="sendOTP()">إرسال رمز التحقق</button>
      <div class="note small">ملاحظة: من الأفضل أن تكون طلبات Hypersender من الخادم (proxy) لحماية مفتاح الـ API.</div>
    </div>

    <div id="otp-section">
      <p>أدخل رمز الـ OTP المستلم:</p>
      <div class="form-group">
        <label for="otp">رمز التحقق</label>
        <input id="otp" type="text" placeholder="xxxxxx" inputmode="numeric" autocomplete="one-time-code" />
      </div>
      <button id="verify-otp-btn" onclick="verifyAndDelete()">تأكيد وحذف الحساب</button>
    </div>

    <div id="final-message-section">
      <h2 class="success">تم جدولة حذف الحساب</h2>
      <p>تم التحقق بنجاح. سيتم حذف بياناتك نهائيًا بعد الفترة المحددة إذا لم تقم بتسجيل الدخول.</p>
    </div>
  </div>

  <script>
    // -----------------------------
    // أدخل هنا معرّف الانستانس الذي زودتني به
    // -----------------------------
    const INSTANCE_ID = "a0039162-ee15-49c9-a7d0-fc7d1686cf0d";
    // -----------------------------
    // ملاحظة: اترك API_KEY فارغ أو ضع مفتاح للاختبار المحلي فقط.
    // الأفضل أن لا تضع مفتاحًا في الكود على بيئة الإنتاج.
    const API_KEY = ""; // <-- ضع مفتاحك هنا فقط للاختبار المحلي إن أردت

    // افتراض مسارات send/verify — عدّل إذا كان في حسابك مسار مختلف.
    const SEND_OTP_URL = `https://app.hypersender.com/instances/${INSTANCE_ID}/send-otp`;
    const VERIFY_OTP_URL = `https://app.hypersender.com/instances/${INSTANCE_ID}/verify-otp`;

    // بديل آمن: ضع هنا مسار proxy على خادمك (موصى به)
    // مثال: const PROXY_SEND = '/api/hypersender/send-otp';
    //         const PROXY_VERIFY = '/api/hypersender/verify-otp';
    const PROXY_SEND = null;   // اذا أردت استخدام proxy ضع هنا المسار كـ string
    const PROXY_VERIFY = null; // مثال: '/api/verify-otp'

    // عناصر DOM
    const phoneInput = document.getElementById('phone');
    const otpInput = document.getElementById('otp');
    const sendOtpBtn = document.getElementById('send-otp-btn');
    const verifyOtpBtn = document.getElementById('verify-otp-btn');
    const messageBox = document.getElementById('message-box');
    const phoneSection = document.getElementById('phone-section');
    const otpSection = document.getElementById('otp-section');
    const finalMessageSection = document.getElementById('final-message-section');

    function showMessage(text, type) {
      messageBox.textContent = text;
      messageBox.className = 'message ' + (type || '');
      messageBox.style.display = 'block';
    }
    function hideMessage() {
      messageBox.style.display = 'none';
    }
    function setLoading(btn, loading, original) {
      btn.disabled = loading;
      if (loading) btn.textContent = 'جاري المعالجة...';
      else btn.textContent = original;
    }

    async function sendOTP() {
      hideMessage();
      const phone = phoneInput.value.trim();
      if (!phone || !phone.startsWith('+')) {
        showMessage('الرجاء إدخال رقم صحيح مع رمز الدولة (مثال: +9677...).', 'error');
        return;
      }

      const orig = sendOtpBtn.textContent;
      setLoading(sendOtpBtn, true, orig);

      try {
        // إذا عرّفت PROXY_SEND يستعمله (آمن)، وإلا يجرب الاستدعاء المباشر لHypersender (غير آمن)
        const url = PROXY_SEND || SEND_OTP_URL;
        const headers = { 'Content-Type': 'application/json' };
        if (!PROXY_SEND && API_KEY) headers['Authorization'] = `Bearer ${API_KEY}`;

        const res = await fetch(url, {
          method: 'POST',
          headers,
          body: JSON.stringify({ phone })
        });

        const data = await res.json().catch(()=>null);

        if (!res.ok) {
          // محاولة قراءة رسالة مفهومة من الجسم، وإلا عرض رمز الحالة
          const errMsg = (data && (data.message || data.error)) || `فشل: ${res.status}`;
          throw new Error(errMsg);
        }

        // نجاح الإرسال
        showMessage('تم إرسال رمز التحقق إلى هاتفك.', 'success');
        phoneSection.style.display = 'none';
        otpSection.style.display = 'block';
        otpInput.focus();

      } catch (err) {
        showMessage(err.message || 'حدث خطأ أثناء إرسال الرمز.', 'error');
        console.error('sendOTP error:', err);
      } finally {
        setLoading(sendOtpBtn, false, orig);
      }
    }

    async function verifyAndDelete() {
      hideMessage();
      const phone = phoneInput.value.trim();
      const code = otpInput.value.trim();
      if (!code || code.length < 3) {
        showMessage('أدخل رمز تحقق صالح.', 'error');
        return;
      }

      const orig = verifyOtpBtn.textContent;
      setLoading(verifyOtpBtn, true, orig);

      try {
        const url = PROXY_VERIFY || VERIFY_OTP_URL;
        const headers = { 'Content-Type': 'application/json' };
        if (!PROXY_VERIFY && API_KEY) headers['Authorization'] = `Bearer ${API_KEY}`;

        const res = await fetch(url, {
          method: 'POST',
          headers,
          body: JSON.stringify({ phone, code })
        });

        const data = await res.json().catch(()=>null);

        if (!res.ok) {
          const errMsg = (data && (data.message || data.error)) || `فشل: ${res.status}`;
          throw new Error(errMsg);
        }

        // تحقق ناجح؟ (تعتمد على حقل الاستجابة من Hypersender)
        const ok = (data && (data.verified === true || data.success === true)) || false;

        if (ok) {
          otpSection.style.display = 'none';
          phoneSection.style.display = 'none';
          messageBox.style.display = 'none';
          finalMessageSection.style.display = 'block';
          // ملاحظة: هنا يمكنك إضافة استدعاء آخر لخادمك لحذف/جدولة الحذف فعليًا
        } else {
          // إن لم ترجع Hypersender حقل واضح، حاول إظهار رسالة من body
          const msg = (data && (data.message || data.error)) || 'الرمز غير صحيح أو منتهي الصلاحية.';
          showMessage(msg, 'error');
        }

      } catch (err) {
        showMessage(err.message || 'حدث خطأ أثناء التحقق.', 'error');
        console.error('verifyAndDelete error:', err);
      } finally {
        setLoading(verifyOtpBtn, false, orig);
      }
    }
  </script>
</body>
</html>
