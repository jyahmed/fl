<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حذف الحساب</title>
    <style>
        /* نفس تصميم CSS لم يتغير */
        body { font-family: 'Cairo', sans-serif; line-height: 1.8; color: #333; background-color: #f4f7f6; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { max-width: 500px; width: 100%; background-color: #fff; padding: 30px 40px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        h1 { color: #d9534f; text-align: center; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; text-align: left; direction: ltr; }
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; background-color: #0275d8; color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .message { padding: 15px; margin-top: 20px; border-radius: 8px; text-align: center; display: none; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        #otp-section { display: none; }
        #final-message-section { display: none; text-align: center; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>حذف الحساب نهائياً</h1>
        <div id="message-box" class="message"></div>

        <div id="phone-section">
            <p>أدخل رقم هاتفك المسجل لدينا لبدء عملية الحذف.</p>
            <div class="form-group">
                <label for="phone">رقم الهاتف (بدون رمز الدولة )</label>
                <input type="tel" id="phone" placeholder="7xxxxxxxx">
            </div>
            <button id="send-otp-btn" onclick="sendOTP()">إرسال رمز التحقق</button>
        </div>

        <div id="otp-section">
            <p>لقد أرسلنا رمزًا إلى رقمك. يرجى إدخاله أدناه.</p>
            <div class="form-group">
                <label for="otp">رمز التحقق (OTP)</label>
                <input type="text" id="otp" placeholder="xxxxxx" inputmode="numeric" autocomplete="one-time-code">
            </div>
            <button id="verify-otp-btn" onclick="verifyAndDelete()">تأكيد وحذف الحساب</button>
        </div>

        <div id="final-message-section">
            <h2 class="success">تم استلام طلبك بنجاح</h2>
            <p>لقد قمت بطلب حذف حسابك. سيتم الاحتفاظ ببياناتك لمدة 10 أيام، إذا لم تقم بتسجيل الدخول خلال هذه الفترة، سيتم حذف بياناتك بشكل نهائي.</p>
        </div>
    </div>

    <script>
        // =================================================================
        // ===              روابط دوال الخادم الآمنة                  ===
        // =================================================================
        // استبدل هذه الروابط إذا تغيرت في المستقبل
        const START_VERIFICATION_URL = "https://startaccountdeletionverification-hzaw42xaq-zf.a.run.app";
        const SCHEDULE_DELETION_URL = "https://scheduleaccountdeletion-hzaw42xiaq-zf.a.run.app"; // تم التحديث إلى الدالة الصحيحة
        // =================================================================

        // عناصر الواجهة
        const phoneInput = document.getElementById('phone' );
        const otpInput = document.getElementById('otp');
        const sendOtpBtn = document.getElementById('send-otp-btn');
        const verifyOtpBtn = document.getElementById('verify-otp-btn');
        const messageBox = document.getElementById('message-box');
        const phoneSection = document.getElementById('phone-section');
        const otpSection = document.getElementById('otp-section');
        const finalMessageSection = document.getElementById('final-message-section');

        function showMessage(text, type) {
            messageBox.textContent = text;
            messageBox.className = `message ${type}`;
            messageBox.style.display = 'block';
        }

        function setLoading(button, isLoading, originalText) {
            button.disabled = isLoading;
            button.textContent = isLoading ? 'جاري المعالجة...' : originalText;
        }

        async function sendOTP() {
            const phone = phoneInput.value.trim();
            if (!/^(71|78|73|70|77)[0-9]{7}$/.test(phone)) {
                showMessage('الرجاء إدخال رقم هاتف يمني صحيح.', 'error');
                return;
            }

            const originalBtnText = sendOtpBtn.textContent;
            setLoading(sendOtpBtn, true, originalBtnText);
            messageBox.style.display = 'none';

            try {
                // استدعاء دالة الخادم الآمنة لإرسال الرمز
                const response = await fetch(START_VERIFICATION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone: phone })
                });

                const data = await response.json();

                if (!response.ok) {
                    // إذا لم تكن الاستجابة ناجحة، استخدم رسالة الخطأ من الخادم
                    throw new Error(data.error || 'حدث خطأ غير متوقع.');
                }

                showMessage('تم إرسال رمز التحقق بنجاح.', 'success');
                phoneSection.style.display = 'none';
                otpSection.style.display = 'block';
                otpInput.focus(); // تحسين: التركيز على حقل الرمز

            } catch (error) {
                showMessage(error.message, 'error');
            } finally {
                setLoading(sendOtpBtn, false, originalBtnText);
            }
        }

        async function verifyAndDelete() {
            const phone = phoneInput.value.trim();
            const code = otpInput.value.trim();

            if (code.length < 4) {
                showMessage('الرجاء إدخال رمز تحقق صحيح.', 'error');
                return;
            }

            const originalBtnText = verifyOtpBtn.textContent;
            setLoading(verifyOtpBtn, true, originalBtnText);
            messageBox.style.display = 'none';

            try {
                // استدعاء دالة الخادم الآمنة للتحقق وجدولة الحذف
                const response = await fetch(SCHEDULE_DELETION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone: phone, code: code })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'حدث خطأ أثناء التحقق.');
                }

                // إظهار رسالة النجاح النهائية
                otpSection.style.display = 'none';
                document.querySelector('h1').style.display = 'none';
                messageBox.style.display = 'none';
                finalMessageSection.style.display = 'block';

            } catch (error) {
                showMessage(error.message, 'error');
            } finally {
                setLoading(verifyOtpBtn, false, originalBtnText);
            }
        }
    </script>
</body>
</html>
