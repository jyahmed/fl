<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مثال Firebase MFA - ويب (SMS)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 720px; margin: 24px auto; padding: 12px; direction: rtl; }
    input, button { padding: 8px; margin: 6px 0; width: 100%; box-sizing: border-box; }
    .card { border:1px solid #ddd; padding:12px; border-radius:8px; margin-bottom:14px; background:#fafafa; }
    small { color:#666; }
  </style>
</head>
<body>
  <h2>مثال Firebase MFA (ويب) — SMS</h2>

  <div class="card">
    <h3>تهيئة Firebase</h3>
    <small>ضع إعدادات firebaseConfig في الكود أدناه من مشروعك في Firebase Console.</small>
  </div>

  <div class="card">
    <h3>إنشاء حساب (Email / Password)</h3>
    <input id="signupEmail" placeholder="البريد الإلكتروني" />
    <input id="signupPass" placeholder="كلمة المرور" type="password" />
    <button id="btnSignup">إنشاء حساب</button>
  </div>

  <div class="card">
    <h3>تسجيل دخول (Email / Password)</h3>
    <input id="loginEmail" placeholder="البريد الإلكتروني" />
    <input id="loginPass" placeholder="كلمة المرور" type="password" />
    <button id="btnLogin">تسجيل الدخول</button>
    <div id="mfaPrompt" style="display:none;">
      <p>رمز أُرسل إلى هاتفك. أدخل الكود هنا:</p>
      <input id="mfaCode" placeholder="أدخل رمز الـ SMS" />
      <button id="btnFinishSignin">إكمال تسجيل الدخول</button>
    </div>
  </div>

  <div class="card">
    <h3>تسجيل عامل ثانٍ (إضافة رقم هاتف للمستخدم الحالي)</h3>
    <input id="enrollPhone" placeholder="+900000000000" />
    <div id="recaptcha-enroll"></div>
    <button id="btnSendEnroll">إرسال رمز للتسجيل</button>
    <input id="enrollCode" placeholder="ادخل كود التسجيل" />
    <button id="btnCompleteEnroll">إكمال إضافة الهاتف</button>
  </div>

  <div class="card">
    <h3>الحالة</h3>
    <pre id="status">غير متصل</pre>
  </div>

  <!-- إضافة مكتبات Firebase (modular SDK) -->
  <script type="module">
    // ======= ضع هنا إعدادات مشروعك من Firebase Console =======
const firebaseConfig = {
  apiKey: "AIzaSyBkYLrmedVI9VZOCZ0xj6HvVSsGGm8OhHs",
  authDomain: "coffee-spark-ai-barista-41d7a.firebaseapp.com",
  projectId: "coffee-spark-ai-barista-41d7a",
  storageBucket: "coffee-spark-ai-barista-41d7a.firebasestorage.app",
  messagingSenderId: "515148094227",
  appId: "1:515148094227:web:845baa681e936daa0b98e6"
};
    // =======================================================

    // استيراد المكتبات (modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      RecaptchaVerifier,
      signOut,
      PhoneAuthProvider,
      multiFactor,
      PhoneMultiFactorGenerator,
      getMultiFactorResolver
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // عناصر الواجهة
    const statusEl = document.getElementById('status');
    const updateStatus = (txt) => statusEl.textContent = txt;

    // ======== Signup =========
    document.getElementById('btnSignup').addEventListener('click', async () => {
      const email = document.getElementById('signupEmail').value;
      const pass = document.getElementById('signupPass').value;
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, pass);
        updateStatus(`حساب مُنشأ: ${userCred.user.uid}\nالمرجو تفعيل البريد قبل تفعيل MFA`);
      } catch (err) {
        updateStatus('خطأ في الإنشاء: ' + err.message);
      }
    });

    // ======== Enroll (إضافة رقم هاتف كعامل ثانٍ) =========
    // إعداد reCAPTCHA خاص بعملية التسجيل (enrollment)
    let enrollRecaptchaVerifier = null;
    function ensureEnrollRecaptcha() {
      if (!enrollRecaptchaVerifier) {
        enrollRecaptchaVerifier = new RecaptchaVerifier('recaptcha-enroll', {
          size: 'invisible'
        }, auth);
      }
      return enrollRecaptchaVerifier;
    }

    document.getElementById('btnSendEnroll').addEventListener('click', async () => {
      try {
        const user = auth.currentUser;
        if (!user) throw new Error('سجّل الدخول أولًا كمستخدم لتضيف رقم الهاتف.');

        // 1) إحضار جلسة multi-factor الخاصة بالمستخدم
        const mfaSession = await multiFactor(user).getSession();

        // 2) إعداد reCAPTCHA وطلب إرسال رمز SMS مرتبط بجلسة الـ MFA
        const phoneNumber = document.getElementById('enrollPhone').value;
        ensureEnrollRecaptcha();
        const verifier = enrollRecaptchaVerifier;

        // إنشاء Provider لارسال SMS ضمن جلسة MFA
        const phoneProvider = new PhoneAuthProvider(auth);
        const verificationId = await phoneProvider.verifyPhoneNumber({
          phoneNumber,
          multiFactorSession: mfaSession,
          // بعد إصدار المكتبة، الطريقة قد تطلب set of options — هنا نستخدم الشكل البسيط
          // في حال واجهتك أخطاء، راجع docs (الرابط أسفل)
        }, verifier);

        // حفظ verificationId مؤقتًا في الـ DOM (أو state)
        window._enrollVerificationId = verificationId;
        updateStatus('تم إرسال رمز التسجيل إلى الهاتف. أدخله ثم اضغط إكمال إضافة الهاتف.');
      } catch (err) {
        updateStatus('خطأ أثناء الإرسال: ' + err.message);
      }
    });

    document.getElementById('btnCompleteEnroll').addEventListener('click', async () => {
      try {
        const code = document.getElementById('enrollCode').value;
        const verificationId = window._enrollVerificationId;
        if (!verificationId) throw new Error('لم يتم إرسال رمز التسجيل بعد.');
        // إنشاء PhoneAuthCredential من الـ verificationId + code
        const cred = PhoneAuthProvider.credential(verificationId, code);
        const assertion = PhoneMultiFactorGenerator.assertion(cred);

        // enroll العامل الثاني للمستخدم الحالي
        const user = auth.currentUser;
        await multiFactor(user).enroll(assertion, "هاتف المستخدم");
        updateStatus('تمت إضافة الهاتف كعامل ثانٍ بنجاح.');
      } catch (err) {
        updateStatus('خطأ أثناء إكمال التسجيل: ' + err.message);
      }
    });

    // ======== Signin (تسجيل الدخول ومعالجة MFA) =========
    let currentResolver = null;
    document.getElementById('btnLogin').addEventListener('click', async () => {
      const email = document.getElementById('loginEmail').value;
      const pass = document.getElementById('loginPass').value;

      try {
        // محاولة تسجيل دخول عادي
        await signInWithEmailAndPassword(auth, email, pass);
        updateStatus('تم تسجيل الدخول بدون طلب عامل ثانٍ.');
      } catch (err) {
        // في حال كان الخطأ متعلق بـ multi-factor سيعطينا resolver
        // في مكتبة Moduler: يجب استخرج resolver بواسطة getMultiFactorResolver
        // لاحظ: الخطأ قد يكون نسخة مكتبية مختلفة حسب إصدار الـ SDK؛ هنا نحاول التعامل العام
        try {
          // الحصول على MultiFactor Resolver (إن وُجد)
          // الخطوة: Firebase تُرمز الخطأ وتضع response.rawUserCredential أو معلومات مماثلة
          // أفضل طريقة: استعمل getMultiFactorResolver(err) عندما يدعمها SDK
          currentResolver = getMultiFactorResolver(auth, err);
        } catch (e) {
          currentResolver = null;
        }

        if (currentResolver) {
          updateStatus('هذا الحساب مُفعّل بـ MFA. جارٍ إرسال رمز إلى الهاتف المُسجَّل...');
          // نأخذ أول hint (المعلومات عن العامل الثاني)
          const hint = currentResolver.hints[0]; // غالبًا PhoneMultiFactorInfo
          // أرسل رمز SMS باستخدام PhoneAuthProvider مع resolver.session
          const phoneProvider = new PhoneAuthProvider(auth);
          // نستخدم نفس reCAPTCHA (يمكن استخدام واحد عام)
          const verifier = new RecaptchaVerifier(document.createElement('div'), { size: 'invisible' }, auth);
          const verificationId = await phoneProvider.verifyPhoneNumber({
            phoneNumber: hint.phoneNumber,
            multiFactorSession: currentResolver.session
          }, verifier);

          // خزّن verificationId مؤقتًا
          window._signinVerificationId = verificationId;

          // أظهر مربع إدخال الكود في الواجهة
          document.getElementById('mfaPrompt').style.display = 'block';
          updateStatus('أُرسل رمز. أدخله لإكمال الدخول.');
        } else {
          updateStatus('خطأ أثناء تسجيل الدخول: ' + err.message);
        }
      }
    });

    // بعد إدخال كود الـ MFA لإكمال الدخول
    document.getElementById('btnFinishSignin').addEventListener('click', async () => {
      try {
        const code = document.getElementById('mfaCode').value;
        const verificationId = window._signinVerificationId;
        if (!verificationId || !currentResolver) throw new Error('لا يوجد جلسة MFA نشطة.');

        const cred = PhoneAuthProvider.credential(verificationId, code);
        const assertion = PhoneMultiFactorGenerator.assertion(cred);

        // إكمال عملية تسجيل الدخول عبر resolver
        await currentResolver.resolveSignIn(assertion);
        updateStatus('تم تسجيل الدخول بنجاح باستخدام MFA.');
        document.getElementById('mfaPrompt').style.display = 'none';
      } catch (err) {
        updateStatus('فشل إكمال تسجيل الدخول: ' + err.message);
      }
    });

    // تهيئة الأحداث العامة للحالة
    auth.onAuthStateChanged(user => {
      if (user) {
        updateStatus(`مستخدَم مسجَّل: ${user.email} (UID: ${user.uid})`);
      } else {
        updateStatus('غير متصل');
      }
    });

  </script>
</body>
</html>
